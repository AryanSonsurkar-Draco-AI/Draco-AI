<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Draco Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-start: #0f0c1f;    /* dark purple */
      --bg-end: #171333;
      --card: #1c1842;
      --accent: #7c4dff;      /* purple */
      --accent-2: #00bfa5;    /* teal */
      --text: #ece8ff;
      --muted: #a7a2c7;
      --line: #2b2753;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', 'Inter', system-ui, Arial, sans-serif; margin: 0; color: var(--text);
      background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
      min-height: 100dvh;
    }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 18px; }
    h1 { font-size: 30px; margin: 0 0 10px; letter-spacing: 0.4px; }
    .status { display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 14px; margin-bottom: 14px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#ff5c5c; }
    .dot.on { background:#25ff9b; }
    .card { position:relative; background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.25); }
    .row { display: flex; gap: 10px; }
    .input { display:flex; gap:10px; align-items:center; padding:10px; border-radius: 12px; border:1px solid var(--line); background:#151236; }
    input[type=text] { flex: 1; padding: 12px; border-radius: 10px; border: none; outline: none; background: transparent; color: var(--text); font-size: 15px; }
    /* Ensure file input stays within sidebar width */
    input[type=file].input { display:block; width:100%; padding:10px; background:#151236; border:1px solid var(--line); border-radius:10px; color:var(--text); }
    input[type=file].input::file-selector-button { background: var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; margin-right:10px; cursor:pointer; }
    input[type=file].input::-webkit-file-upload-button { background: var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; margin-right:10px; cursor:pointer; }
    .btn { padding: 12px 14px; border-radius: 10px; border: 1px solid var(--accent); background: var(--accent); color: #fff; cursor: pointer; transition: transform .08s ease, box-shadow .15s ease, filter .15s ease; }
    .btn:hover { filter: brightness(.95); transform: translateY(-1px); }
    .btn:disabled { opacity:.55; cursor:not-allowed; filter: grayscale(.3); }
    .chipbar { display:flex; flex-wrap: wrap; gap:8px; margin-top:10px; }
    .chip { padding:8px 12px; border-radius: 999px; border:1px solid var(--line); color:#d9d3ff; background: #17143a; cursor:pointer; }
    .chip:hover { background:#1b1746; }
    .log { margin-top: 16px; max-height: 520px; overflow: auto; padding-right: 4px; }
    .item { background:#151236; border:1px solid var(--line); border-radius: 12px; padding:12px; margin:10px 0; }
    /* Bot replies: darker than user for contrast */
    body.light-mode .item.bot-item { background: linear-gradient(180deg, #e75a00, #c73d00); border-color: rgba(200,90,30,.7); }
    body.light-mode .item.bot-item .bot { color:#ffffff; }
    /* User messages: bright orange */
    body.light-mode .item.user-item { background: linear-gradient(180deg, #ff8a00, #ff5500); border-color: rgba(255,120,60,.6); }
    body.light-mode .item.user-item .user { color:#ffffff; }
    /* Fallback using :has for browsers supporting it */
    @supports(selector(.item:has(.bot))) {
      body.light-mode .item:has(.bot) { background: linear-gradient(180deg, #e75a00, #c73d00); border-color: rgba(200,90,30,.7); }
      body.light-mode .item:has(.user) { background: linear-gradient(180deg, #ff8a00, #ff5500); border-color: rgba(255,120,60,.6); }
      body.light-mode .item:has(.bot) .bot,
      body.light-mode .item:has(.user) .user { color:#ffffff; }
    }

    /* Dark mode: make bot bubbles slightly darker than user */
    body.dark-mode .item.user-item { background: #151236; border-color: var(--line); }
    body.dark-mode .item.bot-item { background: #0f0b2a; border-color: rgba(90,70,160,.6); }
    body.dark-mode .item.bot-item .bot, body.dark-mode .item.user-item .user { color: var(--text); }
    .user { color:#b7a7ff; }
    .bot { color:#9bf0e2; }
    small { color:var(--muted); }
    /* layout: sidebar + main */
    .layout { display:grid; grid-template-columns: 290px 1fr; gap:14px; }
    .side { background: var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; overflow:auto; }
    .profile { display:flex; flex-direction:column; align-items:center; gap:8px; padding:14px 8px 8px; border-bottom:1px solid rgba(111,141,255,.18); }
    .avatar { width:64px; height:64px; border-radius:50%; display:grid; place-items:center; color:#fff; border:1px solid var(--line); overflow:hidden; flex-shrink:0; margin-bottom:20px; position:relative; transition: transform .3s ease-in-out; }
    body.light-mode .avatar { background:#b30000; }
    body.dark-mode .avatar { background:#070514; }
    .avatar:hover { transform: scale(1.1); }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .avatar .fallback { width:100%; height:100%; display:grid; place-items:center; font-weight:700; font-size:1.4rem; }
    body.light-mode .avatar { box-shadow: 0 0 18px rgba(255, 170, 0, .45); }
    body.dark-mode .avatar { box-shadow: 0 0 18px rgba(120, 100, 255, .45); }
    @keyframes logoPulse { 0%,100%{ filter: drop-shadow(0 0 6px rgba(255,180,80,.6)); } 50%{ filter: drop-shadow(0 0 12px rgba(255,220,120,.9)); } }
    @keyframes logoPulseDark { 0%,100%{ filter: drop-shadow(0 0 6px rgba(120,100,255,.6)); } 50%{ filter: drop-shadow(0 0 12px rgba(160,140,255,.9)); } }
    body.light-mode .avatar { animation: logoPulse 2.2s infinite ease-in-out; }
    body.dark-mode .avatar { animation: logoPulseDark 2.2s infinite ease-in-out; }
    .meta small { color:var(--muted); display:block; font-style: italic; font-size: .9rem; letter-spacing: .3px; }
    #profName { font-weight: 700; font-size: 1.5rem; letter-spacing: .5px; }
    .btn { text-transform: uppercase; }
    .history { margin-top:12px; max-height: 520px; overflow:auto; }
    .hitem { padding:8px 10px; border-radius:10px; border:1px solid var(--line); margin:8px 0; color:#d9d3ff; background:#151236; cursor:pointer; }
    .hitem:hover { background:#1b1746; }
    .sideActions { display:flex; gap:8px; margin-top:10px; }
    .toggleBar { text-align:right; margin-bottom:8px; }
    .layout.collapsed { grid-template-columns: 0 1fr; }
    .layout.expanded { grid-template-columns: 420px 1fr; }

    /* THEME OVERRIDES AND ENHANCEMENTS */
    :root { --transition: 0.6s ease-in-out; }
    body { transition: background var(--transition), color var(--transition); }

    /* Dark mode (default) */
    body.dark-mode {
      --bg-start: #2b004f;
      --bg-end: #0b001f;
      --card: rgba(20, 12, 40, 0.55);
      --accent: #2200aa;
      --accent-2: #5d3bff;
      --text: #f5f5f5;
      --muted: #bfbad9;
      --line: rgba(110, 90, 190, 0.35);
    }

    /* Light mode */
    body.light-mode {
      --bg-start: #ff6a00;
      --bg-end: #cc3300;
      --card: rgba(255, 255, 255, 0.65);
      --accent: #b30000;
      --accent-2: #ffaa00;
      --text: #ff0000;
      --muted: #ffe1c9;
      --line: rgba(255, 180, 120, 0.55);
    }

    /* global bg */
    body.dark-mode,
    body.light-mode {
      background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    }
    /* Force red text across UI in light mode */
    body.light-mode,
    body.light-mode .wrap,
    body.light-mode .card,
    body.light-mode .side,
    body.light-mode .chip,
    body.light-mode .hitem,
    body.light-mode .item,
    body.light-mode .status,
    body.light-mode .meta,
    body.light-mode label,
    body.light-mode .row,
    body.light-mode .log,
    body.light-mode small,
    body.light-mode .input,
    body.light-mode .input input { color: var(--text); }
    body.light-mode input::placeholder { color: rgba(255,0,0,0.85); }
    body.light-mode .chip { color: var(--text); }

    /* Sidebar glass */
    .side { background: var(--card); backdrop-filter: blur(12px); box-shadow: 0 0 24px rgba(0,0,0,.25), inset 0 0 0 1px var(--line); }

    /* Chat panel glow */
    .card { box-shadow: 0 0 0 1px var(--line), 0 0 28px rgba(0,0,0,.25); }

    /* Buttons */
    .btn { position: relative; border-radius: 15px; padding: 12px 20px; font-weight: 700; letter-spacing: .5px; text-transform: uppercase; border: 1px solid transparent; transition: background var(--transition), box-shadow var(--transition), transform .2s ease; }
    body.light-mode .btn { background: #b30000; border-color: rgba(255,120,60,.35); box-shadow: 0 0 12px rgba(255, 120, 60, .25); }
    body.dark-mode .btn { background: #2200aa; border-color: rgba(120,100,255,.35); box-shadow: 0 0 12px rgba(120, 100, 255, .25); }
    .btn:hover { transform: scale(1.05); }
    body.light-mode .btn:hover { box-shadow: 0 0 22px rgba(255, 160, 60, .55); }
    body.dark-mode .btn:hover { box-shadow: 0 0 22px rgba(120, 100, 255, .55); }

    /* Flame particle system */
    @keyframes flameRise {
      0% { transform: translateY(0) scale(1); opacity: .9; }
      50% { opacity: 1; }
      100% { transform: translateY(-30px) scale(.5); opacity: 0; }
    }
    .flame-particle { position:absolute; width:4px; height:10px; border-radius:50%; filter: blur(2px); animation: flameRise 2s infinite ease-in-out; }
    body.light-mode .flame-particle { background: linear-gradient(to top, #ff6600, #ff3300); }
    body.dark-mode .flame-particle { background: linear-gradient(to top, #4400aa, #6600ff); }
    .button-container { position: relative; }
    .button-container::before, .button-container::after { content:""; position:absolute; bottom:0; left:50%; width:6px; height:15px; border-radius:50%; animation: flameRise 1.5s infinite ease-in-out; opacity:.8; transform: translateX(-50%); }
    body.light-mode .button-container::before, body.light-mode .button-container::after { background: linear-gradient(to top, #ffaa00, #ff3300); }
    body.dark-mode .button-container::before, body.dark-mode .button-container::after { background: linear-gradient(to top, #330066, #6600ff); }

    /* Theme toggle (checkbox + label) */
    .theme-toggle { position: relative; width:56px; height:28px; display:inline-block; cursor:pointer; }
    .theme-toggle .slider { position:absolute; inset:0; border-radius:999px; border:1px solid var(--line); transition: all 0.4s ease-in-out; box-shadow: 0 0 12px rgba(0,0,0,.25); }
    /* Gradient by theme */
    body.light-mode .theme-toggle .slider { background: linear-gradient(90deg, #ff9900, #cc3300); box-shadow: 0 0 12px rgba(255,140,60,.45); }
    body.dark-mode .theme-toggle .slider { background: linear-gradient(90deg, #3a00b3, #0044ff); box-shadow: 0 0 12px rgba(120,100,255,.45); }
    .theme-toggle .slider::before { content:""; position:absolute; top:2px; left:2px; width:24px; height:24px; background:#fff; border-radius:50%; transition: all 0.4s ease-in-out; box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    /* Slide when checked */
    #themeCheckbox:checked + label.theme-toggle .slider::before { transform: translateX(24px); }

    /* Inputs and chips adapt */
    .chip { background:#17143a; }
    .chip:hover { background:#1b1746; }
    body.light-mode .chip { background: rgba(255,255,255,.25); }
    /* Inputs: light mode orange boxes with white text */
    body.light-mode .input { background: linear-gradient(180deg, #ff8a00, #ff5500); color:#fff; border-color: rgba(255,120,60,.5); }
    body.light-mode input[type=text] { color:#ffffff; }
    body.light-mode input[type=text]::placeholder { color: rgba(255,255,255,0.85); }

    /* Flame background */
    .flames { position: fixed; left:0; right:0; bottom:0; height:180px; pointer-events:none; z-index:0; overflow:hidden; }
    .flame { position:absolute; bottom:-20px; width:60px; height:120px; background: radial-gradient(50% 60% at 50% 60%, rgba(40,0,60,.45), transparent 70%); filter: blur(6px); animation: rise 6s infinite ease-in-out; opacity:.7; }
    .flame.f2 { width:80px; height:140px; background: radial-gradient(50% 60% at 50% 60%, rgba(90,40,160,.28), transparent 70%); animation-duration:7.5s; animation-delay:.6s; }
    .flame.f3 { width:50px; height:110px; background: radial-gradient(50% 60% at 50% 60%, rgba(140,90,220,.18), transparent 70%); animation-duration:5.5s; animation-delay:.3s; }
    body.light-mode .flame { background: radial-gradient(50% 60% at 50% 60%, rgba(255,170,0,.35), transparent 70%); }
    body.light-mode .flame.f2 { background: radial-gradient(50% 60% at 50% 60%, rgba(255,120,0,.25), transparent 70%); }
    body.light-mode .flame.f3 { background: radial-gradient(50% 60% at 50% 60%, rgba(255,80,0,.18), transparent 70%); }
    .flame:nth-child(1){left:8%} .flame:nth-child(2){left:24%} .flame:nth-child(3){left:42%} .flame:nth-child(4){left:64%} .flame:nth-child(5){left:82%}
    @keyframes rise { 0%{transform:translateY(20px) scale(.9);opacity:0} 15%{opacity:.7} 50%{transform:translateY(-40px) scale(1.04)} 100%{transform:translateY(-120px) scale(.96);opacity:0} }

    /* Loader overlay */
    #loaderOverlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(2px); }
    .draco-loader { position:relative; width:130px; height:130px; border-radius:18px; background:var(--card); border:1px solid var(--line); display:grid; place-items:center; box-shadow:0 10px 26px rgba(0,0,0,.25); transition: background var(--transition), border-color var(--transition); }
    .draco-loader img { width:64px; height:64px; object-fit:contain; }
    .flame-pulse { position:absolute; inset:-8px; border-radius:20px; background: radial-gradient(60% 60% at 50% 50%, rgba(90,40,160,.28), transparent 70%); animation:pulse 1.6s infinite ease-in-out; filter: blur(10px); opacity:.7; }
    body.light-mode .flame-pulse { background: radial-gradient(60% 60% at 50% 50%, rgba(255,120,0,.25), transparent 70%); }
    @keyframes pulse { 0%,100%{transform:scale(.96);opacity:.55} 50%{transform:scale(1.04);opacity:.9} }

    /* Floating action bar */
    .floating-bar { position:fixed; right:18px; bottom:18px; background:#0e1230; border:1px solid #4b3a9f; border-radius:16px; box-shadow:0 8px 22px rgba(0,0,0,.28); padding:10px; display:flex; gap:8px; z-index:10; transition: background var(--transition), border-color var(--transition), transform .2s ease; }
    body.light-mode .floating-bar { background:#fff0ea; border-color:#ff6f61; }
    .floating-bar:hover { transform: translateY(-2px); }
    .floating-bar .btn { position:relative; overflow:hidden; }
    .floating-bar .btn::after { content:""; position:absolute; left:-30%; top:0; width:30%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); transform: skewX(-15deg); opacity:0; transition: opacity .25s ease, left .45s ease; }
    .floating-bar .btn:hover::after { opacity:1; left:130%; }

    .themeToggle { margin-top:10px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .toggleSwitch .btn { padding:10px 12px; }

    @media (max-width: 860px) {
      .wrap { margin: 18px auto; }
      .layout { grid-template-columns: 1fr; }
      .floating-bar { right: 12px; bottom: 12px; }
    }
  </style>
</head>
<body>
  <div class="flames" aria-hidden="true">
    <div class="flame"></div>
    <div class="flame f2"></div>
    <div class="flame f3"></div>
    <div class="flame"></div>
    <div class="flame f2"></div>
  </div>
  <div class="wrap">
    <h1>Draco Assistant</h1>
    <div class="status"><span class="dot" id="dot"></span><span id="statusText">Connectingâ€¦</span></div>
    <div class="toggleBar">
      <button class="btn" id="toggleSide">Hide Sidebar</button>
      <button class="btn" id="expandSide">Expand</button>
    </div>
    <div class="layout" id="layout">
      <div class="side" id="sidebar">
        <div class="profile">
          <div class="avatar" id="avatar">
            <img id="dracoLogo" src="/static/draco-logo.jpg" alt="Draco Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';" />
            <div class="fallback" style="display:none;">D</div>
          </div>
          <div class="meta" style="text-align:center;">
            <div id="profName">Draco AI</div>
            <small id="profEmail">Powered by Aryan and his co-workers</small>
          </div>
        </div>
        <div class="card" style="margin-top:10px;">
          <div style="font-weight:600; margin-bottom:10px; text-align:center;">Quick Actions</div>
          <div class="row" style="flex-direction:column; gap:12px;">
            <input id="genTopicSide" type="text" class="input" placeholder="Topic (e.g., Quantum Computing)" />
            <div class="button-container"><button class="btn" id="genPPTSide" style="width:100%;">Generate PPT</button></div>
            <div class="button-container"><button class="btn" id="genPDFSide" style="width:100%;">Generate PDF</button></div>
            <div class="button-container"><button class="btn" id="genDOCSide" style="width:100%;">Generate DOCX</button></div>
            <input id="fileInput" type="file" accept=".pdf,.pptx,.docx" style="display:none;" />
            <input id="instruction" type="text" class="input" placeholder="Instruction (optional, e.g., summarize)" style="display:none;" />
            <div class="button-container"><button class="btn" id="chooseFileBtn" style="width:100%;">Choose File</button></div>
            <div class="button-container"><button class="btn" id="uploadBtn" style="width:100%;">Upload File</button></div>
            <div class="themeToggle" style="margin-top:4px;">
              <div style="font-weight:600;">Theme</div>
              <div class="toggleSwitch" style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="themeCheckbox" style="position:absolute; opacity:0; width:0; height:0;" />
                <label for="themeCheckbox" class="theme-toggle" aria-label="Toggle theme">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div id="fileNameLabel" style="margin-top:2px; color:var(--muted); font-size:13px;"></div>
            <div id="uploadNote" style="margin-top:4px; color:var(--muted); font-size:13px;"></div>
          </div>
        </div>
        <div class="history" id="history"></div>
      </div>
      <div class="card">
        <div class="input" style="margin-bottom:10px;">
          <input id="input" type="text" placeholder="Type a command (e.g., open youtube, play music, take note ...)" />
          <button class="btn" id="sendBtn">Send</button>
        </div>
        <div class="row" style="margin-bottom:10px;">
          <button class="btn" id="micBtn">ðŸŽ¤ Speak</button>
          <button class="btn" id="stopSpeakBtn">ðŸ›‘ Stop Voice</button>
        </div>
        <div class="chipbar" id="chips">
          <div class="chip" data-cmd="open youtube">Open YouTube</div>
          <div class="chip" data-cmd="play music">Play Music</div>
          <div class="chip" data-cmd="take note buy milk">Take Note</div>
          <div class="chip" data-cmd="list notes">List Notes</div>
          <div class="chip" data-cmd="system status">System Status</div>
          <div class="chip" data-cmd="search for render deployment guide">Search Web</div>
        </div>
        <div class="log" id="log"></div>
        <small>Tip: Try "open youtube", "play music", "list notes", "remind me to drink water at 19:30"</small>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const log = document.getElementById('log');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const stopSpeakBtn = document.getElementById('stopSpeakBtn');
    const dot = document.getElementById('dot');
    const statusText = document.getElementById('statusText');

    let socket = null;
    let user = { logged_in: false, email: null, profile: {} };
    let historyItems = [];
    let chatsList = [];
    try {
      socket = io({ transports: ['websocket', 'polling'], withCredentials: false });
    } catch (e) {
      socket = null;
    }

    function appendItem(text, who='bot') {
      const el = document.createElement('div');
      el.className = 'item ' + (who === 'bot' ? 'bot-item' : 'user-item');
      el.innerHTML = `<div class="${who}">${text}</div>`;
      log.appendChild(el);
      log.scrollTop = log.scrollHeight;
    }

    function initials(name) {
      if (!name) return 'U';
      const parts = name.trim().split(/\s+/);
      const a = parts[0]?.[0] || '';
      const b = parts[1]?.[0] || '';
      return (a + b).toUpperCase() || 'U';
    }

    function renderProfile() {
      // Static branding
      const profName = document.getElementById('profName');
      const profEmail = document.getElementById('profEmail');
      if (profName) profName.textContent = 'Draco AI';
      if (profEmail) profEmail.textContent = 'Powered by Aryan and his co-workers';
    }

    function renderHistory() {
      const container = document.getElementById('history');
      if (!container) return;
      container.innerHTML = '';
      // Render chat list with names first
      const list = document.createElement('div');
      (chatsList || []).forEach((c) => {
        const d = document.createElement('div');
        d.className = 'hitem';
        d.textContent = c.name || 'New Chat';
        d.onclick = async () => {
          try {
            await fetch('/api/chats/select', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: c.id }) });
            await loadHistory();
          } catch (e) {}
        };
        list.appendChild(d);
      });
      container.appendChild(list);
      // recent messages preview under list
      historyItems.slice(-30).forEach((it) => {
        const text = (it.who === 'user' ? 'You: ' : 'Draco: ') + it.text;
        const d = document.createElement('div');
        d.className = 'hitem';
        d.textContent = text.length > 80 ? text.slice(0, 77) + 'â€¦' : text;
        try { d.title = new Date((it.ts||0)*1000).toLocaleString(); } catch (e) {}
        d.onclick = () => {
          appendItem(it.text, it.who === 'user' ? 'user' : 'bot');
        };
        container.appendChild(d);
      });
    }

    let voiceEnabled = false;
    function speakText(text) {
      try {
        if (!voiceEnabled) return; // gated by user gesture
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1.0;
        utter.pitch = 1.0;
        utter.lang = 'en-US';
        window.speechSynthesis.speak(utter);
      } catch (e) { /* no-op */ }
    }

    stopSpeakBtn.onclick = () => window.speechSynthesis.cancel();

    async function sendCommand(text) {
      if (!text) return;
      appendItem(text, 'user');
      // Prefer socket if connected
      if (socket && socket.connected) {
        try { socket.emit('user_command', { text }); return; } catch (e) {}
      }
      // Fallback to HTTP
      try {
        const r = await fetch('/api/command', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        if (data && data.action === 'open_url' && data.url) {
          try { window.open(data.url, '_blank'); } catch (e) {}
        }
        const t = (data && data.text) ? String(data.text) : (data && data.error) ? String(data.error) : 'No response';
        if (t) {
          appendItem(t, 'bot');
          speakText(t);
        }
      } catch (e) {
        appendItem('Request failed. Please retry.', 'bot');
      }
    }

    async function loadMe() {
      try {
        const r = await fetch('/me');
        const d = await r.json();
        user = d || { logged_in:false };
        if (!user.logged_in) {
          // guest mode is allowed when directly opening this page
          appendItem('Guest mode: your chats won\'t be saved. Sign in to sync.', 'bot');
          return;
        }
        appendItem('Signed in as ' + user.email, 'bot');
        renderProfile();
        await loadHistory();
        await maybeRunOnboarding();
      } catch (e) { /* ignore */ }
    }

    async function loadHistory() {
      try {
        const [h, l] = await Promise.all([
          fetch('/api/chat_history'),
          fetch('/api/chats')
        ]);
        if (!h.ok) return;
        const d = await h.json();
        if (!d.ok) return;
        historyItems = d.items || [];
        if (l.ok) {
          const dl = await l.json();
          chatsList = (dl && dl.ok) ? dl.chats || [] : [];
        }
        historyItems.slice(-20).forEach(it => {
          appendItem(it.text, it.who === 'user' ? 'user' : 'bot');
        });
        renderHistory();
      } catch (e) {}
    }

    async function maybeRunOnboarding() {
      if (!user.logged_in) return;
      try {
        const r = await fetch('/api/profile');
        if (!r.ok) return;
        const d = await r.json();
        if (!d.ok) return;
        const p = d.profile || {};
        const needed = [];
        if (!p.name) needed.push('name');
        if (!p.language) needed.push('language');
        if (!p.interests) needed.push('interests');
        if (needed.length === 0) return;
        appendItem('Let\'s personalize your experience. I\'ll ask a few quick questions.', 'bot');
        const updates = {};
        if (needed.includes('name')) {
          const v = prompt('What should I call you?');
          if (v) updates.name = v.trim();
        }
        if (needed.includes('language')) {
          const v = prompt('Preferred language (e.g., English, Hindi)?');
          if (v) updates.language = v.trim();
        }
        if (needed.includes('interests')) {
          const v = prompt('Your interests (comma-separated)?');
          if (v) updates.interests = v.trim();
        }
        if (Object.keys(updates).length) {
          await fetch('/api/profile', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(updates) });
          appendItem('Thanks! I\'ll use that to tailor my replies.', 'bot');
        }
      } catch (e) {}
    }

    sendBtn.onclick = () => {
      const val = (input.value || '').trim();
      if (!val) return;
      sendCommand(val);
      input.value = '';
      input.focus();
    };

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    if (socket) {
      socket.on('connect', () => {
        appendItem('Connected to Draco!', 'bot');
        dot.classList.add('on');
        statusText.textContent = 'Online';
        sendBtn.disabled = false;
        micBtn.disabled = false;
        // Load user state/history after connection
        loadMe();
      });
      socket.on('disconnect', () => {
        appendItem('Disconnected. Using HTTP fallbackâ€¦', 'bot');
        dot.classList.remove('on');
        statusText.textContent = 'HTTP mode';
      });
      socket.on('draco_response', (data) => {
        if (!data) return;
        if (data.action === 'open_url' && data.url) {
          try { window.open(data.url, '_blank'); } catch (e) {}
        }
        const text = (data && data.text) ? String(data.text) : '';
        if (text) {
          appendItem(text, 'bot');
          speakText(text);
        }
      });
    } else {
      statusText.textContent = 'HTTP mode';
    }

    // Enable speech on first interaction (autoplay policies)
    document.addEventListener('click', () => {
      if (!voiceEnabled) {
        try { window.speechSynthesis.resume(); } catch (e) {}
        voiceEnabled = true;
      }
    }, { once: true });

    // Browser voice input (Web Speech API) â€“ best effort
    let recognition = null;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-IN';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        sendBtn.click();
      };
      recognition.onerror = (e) => appendItem('Mic error: ' + e.error, 'bot');
      recognition.onend = () => micBtn.disabled = false;
    }

    micBtn.onclick = () => {
      if (!recognition) {
        appendItem('Speech recognition not supported in this browser.', 'bot');
        return;
      }
      try {
        micBtn.disabled = true;
        recognition.start();
      } catch (e) {
        micBtn.disabled = false;
      }
    };

    // Quick chips
    document.getElementById('chips').addEventListener('click', (e) => {
      const t = e.target.closest('.chip');
      if (!t) return;
      const cmd = t.getAttribute('data-cmd');
      input.value = cmd;
      sendBtn.click();
    });
    // Sidebar controls
    const layoutEl = document.getElementById('layout');
    const toggleSide = document.getElementById('toggleSide');
    const expandSide = document.getElementById('expandSide');
    let collapsed = false; let expanded = false;
    toggleSide.onclick = () => {
      collapsed = !collapsed;
      layoutEl.classList.toggle('collapsed', collapsed);
      toggleSide.textContent = collapsed ? 'Show Sidebar' : 'Hide Sidebar';
    };
    expandSide.onclick = () => {
      expanded = !expanded;
      layoutEl.classList.toggle('expanded', expanded);
      expandSide.textContent = expanded ? 'Shrink' : 'Expand';
    };
    // Removed New Chat / Clear buttons per request
    // Update sidebar in guest mode too
    renderProfile();

    // Theme checkbox toggle wiring with persistence
    const THEME_KEY = 'draco-theme';
    const themeCheckbox = document.getElementById('themeCheckbox');
    function applyTheme(theme){
      document.body.classList.remove('light-mode','dark-mode');
      document.body.classList.add(theme);
      try { localStorage.setItem(THEME_KEY, theme); } catch (e) {}
      if (themeCheckbox) themeCheckbox.checked = (theme === 'light-mode');
    }
    const savedTheme = (function(){ try { return localStorage.getItem(THEME_KEY); } catch (e) { return null; } })();
    applyTheme(savedTheme || 'light-mode');
    if (themeCheckbox) {
      themeCheckbox.addEventListener('change', () => {
        const next = themeCheckbox.checked ? 'light-mode' : 'dark-mode';
        applyTheme(next);
      });
    }

    // Upload & Process
    const fileInput = document.getElementById('fileInput');
    const instructionEl = document.getElementById('instruction');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadNote = document.getElementById('uploadNote');
    const chooseFileBtn = document.getElementById('chooseFileBtn');
    if (chooseFileBtn) {
      chooseFileBtn.onclick = () => { fileInput.click(); };
    }
    uploadBtn.onclick = async () => {
      uploadNote.textContent = 'Processing...';
      const f = fileInput.files && fileInput.files[0];
      if (!f) { uploadNote.textContent = 'Please choose a file.'; return; }
      const fd = new FormData();
      fd.append('file', f);
      fd.append('instruction', (instructionEl.value||'').trim());
      try {
        const r = await fetch('/api/upload_process', { method:'POST', body: fd });
        const j = await r.json();
        if (!j.ok) { uploadNote.textContent = 'Error: ' + (j.error||'failed'); return; }
        let msg = '';
        if (j.summary) msg += 'Summary:\n' + j.summary + '\n';
        if (j.text) msg += 'Text:\n' + j.text + '\n';
        appendItem(msg || 'Processed.', 'bot');
        if (j.doc) {
          const a = document.createElement('a');
          a.href = j.doc; a.target = '_blank'; a.textContent = 'Download processed file';
          uploadNote.innerHTML = ''; uploadNote.appendChild(a);
        } else {
          uploadNote.textContent = 'Done.';
        }
      } catch (e) {
        uploadNote.textContent = 'Upload failed.';
      }
    };

    // Ambient flame particles for buttons
    function spawnFlames(container){
      for(let i=0;i<6;i++){
        const p = document.createElement('div');
        p.className = 'flame-particle';
        p.style.left = (20 + Math.random()*60) + '%';
        p.style.bottom = (Math.random()*6) + 'px';
        p.style.animationDelay = (Math.random()*1.5) + 's';
        p.style.opacity = 0.6 + Math.random()*0.4;
        container.style.overflow = 'visible';
        container.appendChild(p);
      }
    }
    document.querySelectorAll('.button-container').forEach(spawnFlames);

    // Generate Files (Sidebar only)
    const genTopicSide = document.getElementById('genTopicSide');
    document.getElementById('genPPTSide').onclick = () => {
      const t = (genTopicSide.value||'').trim(); if (!t) return;
      sendCommand('generate ppt on ' + t);
    };
    document.getElementById('genDOCSide').onclick = () => {
      const t = (genTopicSide.value||'').trim(); if (!t) return;
      sendCommand('generate doc on ' + t);
    };
    document.getElementById('genPDFSide').onclick = () => {
      const t = (genTopicSide.value||'').trim(); if (!t) return;
      sendCommand('generate pdf on ' + t);
    };
  </script>
</body>
</html>


