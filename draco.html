 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Draco Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-start: #0f0c1f;    /* dark purple */
      --bg-end: #171333;
      --card: #1c1842;
      --accent: #7c4dff;      /* purple */
      --accent-2: #00bfa5;    /* teal */
      --text: #ece8ff;
      --muted: #a7a2c7;
      --line: #2b2753;
    }

    * { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
    body { font-family: 'Poppins', 'Inter', system-ui, Arial, sans-serif; margin: 0; color: var(--text);
      background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
      min-height: 100dvh;
      display:flex;
      flex-direction:column;
      width:100%;
    }
    .wrap { flex:1; width:100%; margin: 0; padding: 8px 16px 16px; display:flex; flex-direction:column; }
    h1 { font-size: 30px; margin: 0 0 10px; letter-spacing: 0.4px; }
    .status { display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 14px; margin-bottom: 14px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#ff5c5c; }
    .dot.on { background:#25ff9b; }
    .card { position:relative; background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.24); display:flex; flex-direction:column; }
    .row { display: flex; gap: 12px; }
    .input { display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius: 999px; border:1px solid var(--line); background:#0f1218; }
    input[type=text] { flex: 1; padding: 10px 4px; border-radius: 999px; border: none; outline: none; background: transparent; color: var(--text); font-size: 15px; }
    /* Ensure file input stays within sidebar width */
    input[type=file].input { display:block; width:100%; padding:10px; background:#151236; border:1px solid var(--line); border-radius:10px; color:var(--text); }
    input[type=file].input::file-selector-button { background: var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; margin-right:10px; cursor:pointer; }
    input[type=file].input::-webkit-file-upload-button { background: var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; margin-right:10px; cursor:pointer; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,.06); background: var(--accent); color: #fff; cursor: pointer; transition: transform .08s ease, box-shadow .15s ease, filter .15s ease; box-shadow: 0 2px 10px rgba(0,0,0,.18); }
    .btn:hover { filter: brightness(.98); transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.24); }
    .btn:disabled { opacity:.55; cursor:not-allowed; filter: grayscale(.3); }
    .chipbar { display:flex; flex-wrap: wrap; gap:10px; margin-top:10px; }
    .chip { padding:8px 12px; border-radius: 999px; border:1px solid var(--line); color:#c8d0df; background: #0f1218; cursor:pointer; }
    .chip:hover { background:#121623; }
    .log { margin-top: 8px; padding-right: 4px; padding-bottom: 8px; display:flex; flex-direction:column; gap:8px; }
    .chat-row { display:flex; align-items:flex-end; gap:8px; }
    .chat-row-bot { justify-content:flex-start; }
    .chat-row-user { justify-content:flex-end; }
    .msg-avatar { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:700; flex-shrink:0; box-shadow:0 0 10px rgba(0,0,0,.35); }
    .bot-msg-avatar { background:#020617; color:#e5e7eb; }
    .user-msg-avatar { background:#f97316; color:#111827; }
    body.light-mode .bot-msg-avatar { background:#b30000; color:#fff5f5; }
    body.light-mode .user-msg-avatar { background:#ffd24d; color:#7f1d1d; }
    .item { border-radius: 16px; padding:10px 14px; margin:0; max-width: 72%; line-height:1.5; display:inline-block; font-size:0.95rem; position:relative; }
    /* Bot replies: darker than user for contrast */
    body.light-mode .item.bot-item {
      align-self:flex-start;
      background: linear-gradient(180deg, #e75a00, #c73d00);
      border-color: rgba(200,90,30,.7);
    }
    body.light-mode .item.bot-item .bot { color:#ffffff; }
    /* User messages: bright orange, right-aligned (ChatGPT-like) */
    body.light-mode .item.user-item {
      align-self:flex-end;
      background: linear-gradient(180deg, #ffd24d, #ff8a00);
      border-color: rgba(255,180,80,.7);
      box-shadow: 0 0 16px rgba(255,180,80,.5);
    }
    body.light-mode .item.user-item .user { color:#ffffff; }
    /* Fallback using :has for browsers supporting it */
    @supports(selector(.item:has(.bot))) {
      body.light-mode .item:has(.bot) { background: linear-gradient(180deg, #e75a00, #c73d00); border-color: rgba(200,90,30,.7); }
      body.light-mode .item:has(.user) { background: linear-gradient(180deg, #ff8a00, #ff5500); border-color: rgba(255,120,60,.6); }
      body.light-mode .item:has(.bot) .bot,
      body.light-mode .item:has(.user) .user { color:#ffffff; }
    }

    /* Dark mode: make bot bubbles slightly darker than user */
    /* Dark mode: make bot bubbles slightly darker than user */
    body.dark-mode .item.user-item { align-self:flex-end; background: linear-gradient(135deg, #3b82f6, #22c55e); border-color: rgba(56,189,248,.4); color:#f9fafb; }
    body.dark-mode .item.bot-item { align-self:flex-start; background: #020617; border-color: rgba(148,163,184,.5); color: var(--text); }
    body.dark-mode .item.bot-item .bot, body.dark-mode .item.user-item .user { color: inherit; }
    .user { font-weight:500; }
    .bot { font-weight:500; }
    small { color:var(--muted); }
    .msg-tools { display:flex; gap:6px; margin-top:4px; justify-content:flex-end; font-size:0.78rem; }
    .msg-tools .edit-btn { background:transparent; border:none; color:var(--muted); cursor:pointer; padding:0; }
    .msg-tools .edit-btn:hover { color:var(--accent-2); }
    .reactions { display:flex; gap:6px; margin-top:4px; font-size:0.78rem; align-items:center; }
    .reactions .react-btn { background:transparent; border:1px solid rgba(148,163,184,.6); border-radius:999px; padding:3px 8px; cursor:pointer; color:var(--muted); }
    .reactions .react-btn.reacted { background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.7); color:#22c55e; }
    body.light-mode .reactions .react-btn { border-color:rgba(255,180,120,.7); }
    /* layout: sidebar + main */
    .layout { display:grid; grid-template-columns: 280px minmax(0,1fr); gap:20px; align-items:stretch; }
    .side { background: var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; overflow:auto; display:flex; flex-direction:column; gap:12px; }
    .profile { display:flex; flex-direction:column; align-items:center; gap:8px; padding:14px 8px 8px; border-bottom:1px solid rgba(111,141,255,.18); }
    .avatar { width:64px; height:64px; border-radius:50%; display:grid; place-items:center; color:#fff; border:1px solid var(--line); overflow:hidden; flex-shrink:0; margin-bottom:20px; position:relative; transition: transform .3s ease-in-out; }
    body.light-mode .avatar { background:#b30000; }
    body.dark-mode .avatar { background:#070514; }
    .avatar:hover { transform: scale(1.1); }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .avatar .fallback { width:100%; height:100%; display:grid; place-items:center; font-weight:700; font-size:1.4rem; }
    body.light-mode .avatar { box-shadow: 0 0 18px rgba(255, 170, 0, .45); }
    body.dark-mode .avatar { box-shadow: 0 0 18px rgba(120, 100, 255, .45); }
    @keyframes logoPulse { 0%,100%{ filter: drop-shadow(0 0 6px rgba(255,180,80,.6)); } 50%{ filter: drop-shadow(0 0 12px rgba(255,220,120,.9)); } }
    @keyframes logoPulseDark { 0%,100%{ filter: drop-shadow(0 0 6px rgba(120,100,255,.6)); } 50%{ filter: drop-shadow(0 0 12px rgba(160,140,255,.9)); } }
    body.light-mode .avatar { animation: logoPulse 2.2s infinite ease-in-out; }
    body.dark-mode .avatar { animation: logoPulseDark 2.2s infinite ease-in-out; }
    .meta small { color:var(--muted); display:block; font-style: italic; font-size: .9rem; letter-spacing: .3px; }
    #profName { font-weight: 700; font-size: 1.5rem; letter-spacing: .5px; }
    .btn { text-transform: uppercase; }
    .history { margin-top:12px; max-height: 40vh; overflow:auto; }
    .hitem { padding:8px 10px; border-radius:10px; border:1px solid var(--line); margin:8px 0; color:#d9d3ff; background:#151236; cursor:pointer; }
    .hitem:hover { background:#1b1746; }
    .sideActions { display:flex; gap:8px; margin-top:10px; }
    .toggleBar { text-align:right; margin-bottom:8px; display:none; }
    .layout.collapsed { grid-template-columns: 0 minmax(0,1fr); }
    .layout.expanded { grid-template-columns: 360px minmax(0,1fr); }

    /* THEME OVERRIDES AND ENHANCEMENTS */
    :root { --transition: 0.6s ease-in-out; }
    body { transition: background var(--transition), color var(--transition); }

    /* Dark mode (default) */
    body.dark-mode {
      --bg-start: #2b004f;
      --bg-end: #0b001f;
      --card: rgba(20, 12, 40, 0.55);
      --accent: #2200aa;
      --accent-2: #5d3bff;
      --text: #f5f5f5;
      --muted: #bfbad9;
      --line: rgba(110, 90, 190, 0.35);
    }

    /* Light mode */
    body.light-mode {
      --bg-start: #ff6a00;
      --bg-end: #cc3300;
      --card: rgba(255, 255, 255, 0.65);
      --accent: #b30000;
      --accent-2: #ffaa00;
      --text: #ff0000;
      --muted: #ffe1c9;
      --line: rgba(255, 180, 120, 0.55);
    }

    /* global bg */
    body.dark-mode,
    body.light-mode {
      background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    }
    /* Force red text across UI in light mode */
    body.light-mode,
    body.light-mode .wrap,
    body.light-mode .card,
    body.light-mode .side,
    body.light-mode .chip,
    body.light-mode .hitem,
    body.light-mode .item,
    body.light-mode .status,
    body.light-mode .meta,
    body.light-mode label,
    body.light-mode .row,
    body.light-mode .log,
    body.light-mode small,
    body.light-mode .input,
    body.light-mode .input input { color: var(--text); }
    body.light-mode input::placeholder { color: rgba(255,0,0,0.85); }
    body.light-mode .chip { color: var(--text); }
    /* Make upload status clearly visible in light mode */
    body.light-mode #uploadNote { color: #ff0000 !important; }
    /* Drop zone & progress */
    .dropzone { border:2px dashed var(--line); border-radius:12px; padding:12px; text-align:center; color:var(--muted); transition: background .2s ease, border-color .2s ease; }
    .dropzone.dragover { background: rgba(255, 170, 0, 0.08); border-color: var(--accent-2); }
    .progress { width:100%; height:8px; background: rgba(255,255,255,.15); border-radius:6px; overflow:hidden; margin-top:8px; }
    .progress > span { display:block; height:100%; width:0%; background: var(--accent-2); transition: width .15s linear; }
    /* Animations */
    .fade-in { animation: fadeIn .28s ease-out both; }
    .slide-up { animation: slideUp .28s ease-out both; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes slideUp { from { transform: translateY(8px); opacity:0 } to { transform: translateY(0); opacity:1 } }
    /* Skeletons */
    .skeleton { position: relative; overflow: hidden; background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06)); background-size: 200% 100%; animation: shimmer 1.2s infinite; border-radius: 10px; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skeleton.text { height: 14px; margin: 6px 0; }
    .skeleton.block { height: 64px; margin: 10px 0; }
    /* Error banner (hidden, we use chat stream for errors) */
    .error-banner { display:none !important; padding:10px; border:1px solid rgba(220,40,40,.6); background: rgba(220,40,40,.15); color:#ffb6b6; border-radius:10px; margin-bottom:10px; gap:8px; align-items:center; }
    body.light-mode .error-banner { background:#ffecec; border-color:#ff6b6b; color:#b30000; }
    .error-actions { display:flex; gap:8px; margin-left:auto; }
    .pill { border:1px solid var(--line); padding:6px 12px; border-radius:999px; background:rgba(255,255,255,.06); }

    /* Chat hero (shown when no messages yet) */
    .chat-hero { padding:32px 8px 12px; text-align:center; color:var(--muted); }
    .chat-hero-title { font-size:2.2rem; font-weight:700; margin-bottom:8px; }
    body.dark-mode .chat-hero-title { color:#ffffff; }
    body.light-mode .chat-hero-title { color:#ff0000; }
    .chat-hero-sub { font-size:1rem; }

    /* Typing indicator */
    .typing-indicator { margin-top:4px; display:none; align-items:center; gap:6px; color:var(--muted); font-size:0.9rem; }
    .typing-indicator-text { opacity:0.9; }
    .typing-dots { display:flex; gap:3px; }
    .typing-dot { width:6px; height:6px; border-radius:50%; background:var(--muted); opacity:0.3; animation: typingBlink 1s infinite ease-in-out; }
    .typing-dot:nth-child(2) { animation-delay:0.15s; }
    .typing-dot:nth-child(3) { animation-delay:0.3s; }
    @keyframes typingBlink {
      0%,100% { opacity:0.2; transform:translateY(0); }
      50% { opacity:1; transform:translateY(-2px); }
    }

    /* Sidebar glass */
    .side { background: var(--card); backdrop-filter: blur(12px); box-shadow: 0 0 24px rgba(0,0,0,.25), inset 0 0 0 1px var(--line); }
    .side-close-btn { display:none; }

    /* Chat panel glow */
    .card { box-shadow: 0 0 0 1px var(--line), 0 0 28px rgba(0,0,0,.25); }

    /* Buttons */
    .btn { position: relative; border-radius: 15px; padding: 12px 20px; font-weight: 700; letter-spacing: .5px; text-transform: uppercase; border: 1px solid transparent; transition: background var(--transition), box-shadow var(--transition), transform .2s ease; }
    body.light-mode .btn { background: #b30000; border-color: rgba(255,120,60,.35); box-shadow: 0 0 12px rgba(255, 120, 60, .25); }
    body.dark-mode .btn { background: #2200aa; border-color: rgba(120,100,255,.35); box-shadow: 0 0 12px rgba(120, 100, 255, .25); }

    /* Mobile: chat full width, sidebar as slide-in overlay */
    .mobile-menu-btn { display:none; }

    @media (max-width: 768px) {
      .layout { grid-template-columns: minmax(0,1fr); }
      .side {
        position:fixed;
        top:0;
        bottom:0;
        left:0;
        width:78%;
        max-width:320px;
        z-index:80;
        transform: translateX(-100%);
        transition: transform .25s ease;
      }
      body.mobile-side-open .side { transform: translateX(0); }

      .side-overlay {
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,.45);
        backdrop-filter: blur(2px);
        z-index:75;
      }
      body.mobile-side-open .side-overlay { display:block; }

      .mobile-menu-btn {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        position:fixed;
        top:10px;
        left:10px;
        z-index:90;
        padding:8px 10px;
        border-radius:999px;
        font-size:18px;
      }

      .side-close-btn {
        display:flex;
        align-items:center;
        justify-content:center;
        margin-bottom:8px;
        align-self:flex-end;
        padding:6px 10px;
        font-size:14px;
        border-radius:999px;
      }
    }
    .btn:hover { transform: scale(1.05); }
    body.light-mode .btn:hover { box-shadow: 0 0 22px rgba(255, 160, 60, .55); }
    body.dark-mode .btn:hover { box-shadow: 0 0 22px rgba(120, 100, 255, .55); }

    /* Hide decorative flames for professional look */
    .flames { display:none !important; }
    /* Flame particle system (disabled) */
    @keyframes flameRise {
      0% { transform: translateY(0) scale(1); opacity: .9; }
      50% { opacity: 1; }
      100% { transform: translateY(-30px) scale(.5); opacity: 0; }
    }
    .flame-particle { position:absolute; width:4px; height:10px; border-radius:50%; filter: blur(2px); animation: flameRise 2s infinite ease-in-out; }
    body.light-mode .flame-particle { background: linear-gradient(to top, #ff6600, #ff3300); }
    body.dark-mode .flame-particle { background: linear-gradient(to top, #4400aa, #6600ff); }
    .button-container { position: relative; }
    .button-container::before, .button-container::after { content:""; position:absolute; bottom:0; left:50%; width:6px; height:15px; border-radius:50%; animation: flameRise 1.5s infinite ease-in-out; opacity:.8; transform: translateX(-50%); }
    body.light-mode .button-container::before, body.light-mode .button-container::after { background: linear-gradient(to top, #ffaa00, #ff3300); }
    body.dark-mode .button-container::before, body.dark-mode .button-container::after { background: linear-gradient(to top, #330066, #6600ff); }

    /* Theme toggle (checkbox + label) */
    .theme-toggle { position: relative; width:56px; height:28px; display:inline-block; cursor:pointer; }
    .theme-toggle .slider { position:absolute; inset:0; border-radius:999px; border:1px solid var(--line); transition: all 0.4s ease-in-out; box-shadow: 0 0 12px rgba(0,0,0,.25); }
    /* Gradient by theme */
    body.light-mode .theme-toggle .slider { background: linear-gradient(90deg, #ff9900, #cc3300); box-shadow: 0 0 12px rgba(255,140,60,.45); }
    body.dark-mode .theme-toggle .slider { background: linear-gradient(90deg, #3a00b3, #0044ff); box-shadow: 0 0 12px rgba(120,100,255,.45); }
    .theme-toggle .slider::before { content:""; position:absolute; top:2px; left:2px; width:24px; height:24px; background:#fff; border-radius:50%; transition: all 0.4s ease-in-out; box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    /* Slide when checked */
    #themeCheckbox:checked + label.theme-toggle .slider::before { transform: translateX(24px); }

    /* Inputs and chips adapt */
    .chip { background:#17143a; }
    .chip:hover { background:#1b1746; }
    body.light-mode .chip { background: rgba(255,255,255,.25); }
    /* Inputs: light mode orange boxes with white text */
    body.light-mode .input { background: linear-gradient(180deg, #ff8a00, #ff5500); color:#fff; border-color: rgba(255,120,60,.5); }
    body.light-mode input[type=text] { color:#ffffff; }
    body.light-mode input[type=text]::placeholder { color: rgba(255,255,255,0.85); }

    /* Flame background */
    .flames { position: fixed; left:0; right:0; bottom:0; height:180px; pointer-events:none; z-index:0; overflow:hidden; }
    .flame { position:absolute; bottom:-20px; width:60px; height:120px; background: radial-gradient(50% 60% at 50% 60%, rgba(40,0,60,.45), transparent 70%); filter: blur(6px); animation: rise 6s infinite ease-in-out; opacity:.7; }
    .flame.f2 { width:80px; height:140px; background: radial-gradient(50% 60% at 50% 60%, rgba(90,40,160,.28), transparent 70%); animation-duration:7.5s; animation-delay:.6s; }
    .flame.f3 { width:50px; height:110px; background: radial-gradient(50% 60% at 50% 60%, rgba(140,90,220,.18), transparent 70%); animation-duration:5.5s; animation-delay:.3s; }
    body.light-mode .flame { background: radial-gradient(50% 60% at 50% 60%, rgba(255,170,0,.35), transparent 70%); }
    body.light-mode .flame.f2 { background: radial-gradient(50% 60% at 50% 60%, rgba(255,120,0,.25), transparent 70%); }
    body.light-mode .flame.f3 { background: radial-gradient(50% 60% at 50% 60%, rgba(255,80,0,.18), transparent 70%); }
    .flame:nth-child(1){left:8%} .flame:nth-child(2){left:24%} .flame:nth-child(3){left:42%} .flame:nth-child(4){left:64%} .flame:nth-child(5){left:82%}
    @keyframes rise { 0%{transform:translateY(20px) scale(.9);opacity:0} 15%{opacity:.7} 50%{transform:translateY(-40px) scale(1.04)} 100%{transform:translateY(-120px) scale(.96);opacity:0} }

    /* Loader overlay */
    #loaderOverlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(2px); }
    .draco-loader { position:relative; width:130px; height:130px; border-radius:18px; background:var(--card); border:1px solid var(--line); display:grid; place-items:center; box-shadow:0 10px 26px rgba(0,0,0,.25); transition: background var(--transition), border-color var(--transition); }
    .draco-loader img { width:64px; height:64px; object-fit:contain; }
    .flame-pulse { position:absolute; inset:-8px; border-radius:20px; background: radial-gradient(60% 60% at 50% 50%, rgba(90,40,160,.28), transparent 70%); animation:pulse 1.6s infinite ease-in-out; filter: blur(10px); opacity:.7; }
    body.light-mode .flame-pulse { background: radial-gradient(60% 60% at 50% 50%, rgba(255,120,0,.25), transparent 70%); }
    @keyframes pulse { 0%,100%{transform:scale(.96);opacity:.55} 50%{transform:scale(1.04);opacity:.9} }

    /* Floating action bar */
    .floating-bar { position:fixed; right:18px; bottom:18px; background:#0e1230; border:1px solid #4b3a9f; border-radius:16px; box-shadow:0 8px 22px rgba(0,0,0,.28); padding:10px; display:flex; gap:8px; z-index:10; transition: background var(--transition), border-color var(--transition), transform .2s ease; }
    body.light-mode .floating-bar { background:#fff0ea; border-color:#ff6f61; }
    .floating-bar:hover { transform: translateY(-2px); }
    .floating-bar .btn { position:relative; overflow:hidden; }
    .floating-bar .btn::after { content:""; position:absolute; left:-30%; top:0; width:30%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); transform: skewX(-15deg); opacity:0; transition: opacity .25s ease, left .45s ease; }
    .floating-bar .btn:hover::after { opacity:1; left:130%; }

    .themeToggle { margin-top:10px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .toggleSwitch .btn { padding:10px 12px; }

    /* Quick Actions modal */
    #quickActionsModal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    #quickActionsModal.open { display:flex; }
    .qa-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.45); backdrop-filter: blur(2px); }
    .qa-panel { position:relative; width:calc(100% - 32px); max-width:720px; margin:0 16px; border-radius:18px; background:var(--card); border:1px solid var(--line); box-shadow:0 16px 40px rgba(0,0,0,0.6); padding:14px 16px 16px; max-height:75vh; overflow-y:auto; overflow-x:hidden; }
    .qa-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .qa-header-title { font-weight:600; font-size:14px; }
    .qa-close-btn { padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#0f1218; color:var(--text); cursor:pointer; font-size:12px; }
    @media (max-width: 640px) {
      .qa-panel { border-radius:18px; width:calc(100% - 20px); max-width:none; margin:0 10px; }
    }

    @media (max-width: 860px) {
      .wrap { margin: 0; padding: 8px 10px 12px; }
      .layout { grid-template-columns: 1fr; grid-template-rows: auto auto; }
      .side { order:1; max-height: 40vh; }
      .layout > .card { order:2; min-height: 50vh; }
      .floating-bar { right: 12px; bottom: 12px; }
    }
  </style>
</head>
<body>
  <div class="flames" aria-hidden="true"></div>
  <!-- Mobile sidebar toggle button -->
  <button class="btn mobile-menu-btn" id="mobileMenuBtn" aria-label="Open sidebar">â˜°</button>
  <!-- Mobile sidebar backdrop -->
  <div class="side-overlay" id="sideOverlay"></div>
  <div class="wrap">
    <h1 style="display:none;">Draco AI</h1>
    <div class="status" style="display:none;"><span class="dot" id="dot"></span><span id="statusText">Connectingâ€¦</span></div>
    <div class="toggleBar">
      <button class="btn" id="toggleSide">Hide Sidebar</button>
      <button class="btn" id="expandSide">Expand</button>
    </div>
    <div class="layout" id="layout">
      <div class="side" id="sidebar">
        <button class="btn side-close-btn" id="sideCloseBtn" aria-label="Close sidebar">âœ•</button>
        <div class="profile">
          <div class="avatar" id="avatar" style="width:72px; height:72px;">
            <img id="dracoLogo" src="/static/Draco%20AI%20logo.jpg" alt="Draco Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';" />
            <div class="fallback" style="display:none;">D</div>
          </div>
          <div class="meta" style="text-align:center;">
            <div id="profName">Draco AI</div>
            <small id="profEmail">Powered by Aryan and his co-workers</small>
          </div>
        </div>
        <div class="card" style="margin-top:10px; padding:12px;">
          <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Account</div>
          <div id="authStatus" style="font-size:12px; color:var(--muted); margin-bottom:6px;">Guest â€“ chats not saved</div>
          <div class="input" style="margin-bottom:6px; padding:8px 10px;">
            <input id="loginEmail" type="text" placeholder="Enter email to sign in" style="font-size:13px;" />
          </div>
          <div class="input" style="margin-bottom:8px; padding:8px 10px;">
            <input id="loginCode" type="text" placeholder="Verification code" style="font-size:13px;" />
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn" id="loginBtn" style="flex:1; padding:8px 10px; font-size:12px;">Send Code</button>
            <button class="btn" id="logoutBtn" style="flex:1; padding:8px 10px; font-size:12px; display:none;">Logout</button>
          </div>
        </div>
        <div class="sideActions">
          <button class="btn" id="newChatBtn" style="flex:1; padding:8px 10px; font-size:12px;">New Chat</button>
          <button class="btn" id="clearChatBtn" style="flex:1; padding:8px 10px; font-size:12px;">Clear</button>
        </div>
        <div class="themeToggle" style="margin-top:4px;">
          <div style="font-weight:600;">Theme</div>
          <div class="toggleSwitch" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="themeCheckbox" style="position:absolute; opacity:0; width:0; height:0;" />
            <label for="themeCheckbox" class="theme-toggle" aria-label="Toggle theme">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <!-- Quick Actions moved to bottom sheet -->
        <div class="history" id="history"></div>
        <div class="card" id="memoryCard" style="margin-top:10px;">
          <div style="font-weight:600; margin-bottom:10px; text-align:center;">Your Profile</div>
          <div id="memInfo" style="font-size:14px; color:var(--text);"></div>
          <div class="row" style="flex-direction:column; gap:8px; margin-top:10px;">
            <div class="button-container"><button class="btn" id="editInfoBtn" style="width:100%;">Edit Info</button></div>
            <div class="button-container"><button class="btn" id="forgetMeBtn" style="width:100%;">Forget Me</button></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div id="errorBanner" class="error-banner">
          <span id="errorText">Something went wrong.</span>
          <div class="error-actions">
            <button class="btn" id="copyErrorBtn">Copy Log</button>
            <button class="btn" id="retryBtn">Retry</button>
          </div>
        </div>
        <div id="chatHero" class="chat-hero">
          <div id="heroGreeting" class="chat-hero-title">Good to see you.</div>
          <div class="chat-hero-sub">Ask anything to get started.</div>
        </div>
        <div class="log" id="log"></div>
        <div id="typingIndicator" class="typing-indicator">
          <span class="typing-indicator-text">Draco is thinking</span>
          <div class="typing-dots">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
        <div class="input" style="margin-top:12px;">
          <input id="input" type="text" placeholder="Type a command (e.g., open youtube, play music, take note ...)" />
          <button class="btn" id="quickActionsBtn" style="white-space:nowrap;" title="Quick Actions">+</button>
          <button class="btn" id="sendBtn">Send</button>
        </div>
        <div class="row" style="margin-top:10px; margin-bottom:10px;">
          <button class="btn" id="micBtn">ðŸŽ¤ Speak</button>
          <button class="btn" id="stopSpeakBtn">ðŸ›‘ Stop Voice</button>
        </div>
        <div class="chipbar" id="chips">
          <div class="chip" data-cmd="open youtube">Open YouTube</div>
          <div class="chip" data-cmd="play music">Play Music</div>
          <div class="chip" data-cmd="take note buy milk">Take Note</div>
          <div class="chip" data-cmd="list notes">List Notes</div>
          <div class="chip" data-cmd="system status">System Status</div>
          <div class="chip" data-cmd="search for render deployment guide">Search Web</div>
        </div>
        <div class="chipbar" id="summaryChips" style="margin-top:10px;">
          <div class="chip pill" data-summary="short">Summary: Short</div>
          <div class="chip pill" data-summary="medium">Summary: Medium</div>
          <div class="chip pill" data-summary="detailed">Summary: Detailed</div>
        </div>
        <div class="chipbar" id="fileChips" style="margin-top:10px;">
          <div class="chip" data-instruction="summarize">Summarize File</div>
          <div class="chip" data-instruction="shorten">Shorten File</div>
          <div class="chip" data-instruction="lengthen">Lengthen File</div>
          <div class="chip" data-instruction="search">Search Web For Same</div>
        </div>
        <div class="chipbar" id="workflowChips" style="margin-top:10px;">
          <div class="chip pill" data-action="compare">Compare Files</div>
          <div class="chip pill" data-action="merge">Merge Files</div>
        </div>
        <small>Tip: Try "open youtube", "play music", "list notes", "remind me to drink water at 19:30"</small>
        <div class="card" style="margin-top:12px;">
          <div style="font-weight:600; margin-bottom:8px;">Generated Downloads</div>
          <div id="downloadsPanel" style="font-size:14px; display:flex; flex-direction:column; gap:6px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions bottom sheet modal -->
  <div id="quickActionsModal">
    <div class="qa-backdrop"></div>
    <div class="qa-panel">
      <div class="qa-header">
        <div class="qa-header-title">Quick Actions</div>
        <button id="qaCloseBtn" class="qa-close-btn">X</button>
      </div>
      <div class="row" style="flex-direction:column; gap:12px;">
        <input id="genTopicSide" type="text" class="input" placeholder="Topic (e.g., Quantum Computing)" />
        <div class="button-container"><button class="btn" id="genPPTSide" style="width:100%;">Generate PPT</button></div>
        <div class="button-container"><button class="btn" id="genPDFSide" style="width:100%;">Generate PDF</button></div>
        <div class="button-container"><button class="btn" id="genDOCSide" style="width:100%;">Generate DOCX</button></div>
        <input id="fileInput" type="file" accept=".pdf,.pptx,.docx" style="display:none;" />
        <input id="instruction" type="text" class="input" placeholder="Instruction (optional, e.g., summarize)" style="display:none;" />
        <div class="button-container"><button class="btn" id="chooseFileBtn" style="width:100%;">Choose File</button></div>
        <div class="button-container"><button class="btn" id="uploadBtn" style="width:100%;">Upload File</button></div>
        <div id="dropZone" class="dropzone">Drag & Drop file here</div>
        <div class="progress" id="uploadProgress" style="display:none;"><span></span></div>
        <div id="uploadStep" style="font-size:12px; color:var(--muted); margin-top:4px;"></div>
        <!-- Theme toggle moved to sidebar -->
        <div id="fileNameLabel" style="margin-top:2px; color:var(--muted); font-size:13px;"></div>
        <div id="fileSizeLabel" style="color:var(--muted); font-size:12px;"></div>
        <div id="uploadNote" style="margin-top:4px; color:var(--muted); font-size:13px;"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const log = document.getElementById('log');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const stopSpeakBtn = document.getElementById('stopSpeakBtn');
    const dot = document.getElementById('dot');
    const statusText = document.getElementById('statusText');
    const chatHero = document.getElementById('chatHero');
    const heroGreeting = document.getElementById('heroGreeting');
    const typingIndicator = document.getElementById('typingIndicator');
    const loginEmail = document.getElementById('loginEmail');
    const loginBtn = document.getElementById('loginBtn');
    const loginCode = document.getElementById('loginCode');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sideOverlay = document.getElementById('sideOverlay');
    const sideCloseBtn = document.getElementById('sideCloseBtn');
    // Error banner helpers (moved from top)
    const errorBanner = document.getElementById('errorBanner');
    const errorText = document.getElementById('errorText');
    const copyErrorBtn = document.getElementById('copyErrorBtn');
    const retryBtn = document.getElementById('retryBtn');
    let lastAction = null; // function to retry
    function showError(msg, retryFn){
      const text = msg || 'Something went wrong.';
      appendItem(text, 'bot');
      lastAction = typeof retryFn === 'function' ? retryFn : null;
    }
    function hideError(){ if (errorBanner) errorBanner.style.display = 'none'; }
    if (copyErrorBtn) copyErrorBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(errorText.textContent||''); }catch(e){} };
    if (retryBtn) retryBtn.onclick = ()=>{ hideError(); if (lastAction) lastAction(); };

    // Busy state helpers
    const allButtons = ()=> Array.from(document.querySelectorAll('button.btn'));
    function setBusy(on){ allButtons().forEach(b=> b.disabled = !!on); }

    let socket = null;
    let user = { logged_in: false, email: null, profile: {} };
    let historyItems = [];
    let chatsList = [];
    let lastUserMsgEl = null;
    let lastUserText = '';
    try {
      socket = io({ transports: ['websocket', 'polling'], withCredentials: false });
    } catch (e) {
      socket = null;
    }

    function hideHero(){ if (chatHero) chatHero.style.display = 'none'; }

    function showTyping(on) {
      if (!typingIndicator) return;
      typingIndicator.style.display = on ? 'flex' : 'none';
    }

    function appendItem(text, who='bot') {
      const row = document.createElement('div');
      row.className = 'chat-row ' + (who === 'bot' ? 'chat-row-bot' : 'chat-row-user');

      // Avatar
      const avatar = document.createElement('div');
      avatar.className = 'msg-avatar ' + (who === 'bot' ? 'bot-msg-avatar' : 'user-msg-avatar');
      avatar.textContent = who === 'bot' ? 'D' : 'You';

      const bubble = document.createElement('div');
      bubble.className = 'item ' + (who === 'bot' ? 'bot-item' : 'user-item');
      bubble.innerHTML = `<div class="${who}">${text}</div>`;

      // User tools: edit/resend last message
      if (who === 'user') {
        const tools = document.createElement('div');
        tools.className = 'msg-tools';
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'Edit & resend';
        editBtn.onclick = () => {
          try {
            const raw = bubble.querySelector('.user')?.textContent || '';
            input.value = raw;
            input.focus();
          } catch (e) {}
        };
        tools.appendChild(editBtn);
        bubble.appendChild(tools);

        lastUserMsgEl = bubble;
        lastUserText = text;
      }

      // Bot reactions
      if (who === 'bot') {
        const reactions = document.createElement('div');
        reactions.className = 'reactions';
        const label = document.createElement('span');
        label.textContent = 'Was this helpful?';

        const up = document.createElement('button');
        up.type = 'button';
        up.className = 'react-btn';
        up.textContent = 'ðŸ‘';

        const down = document.createElement('button');
        down.type = 'button';
        down.className = 'react-btn';
        down.textContent = 'ðŸ‘Ž';

        up.onclick = () => {
          up.classList.toggle('reacted', true);
          down.classList.toggle('reacted', false);
        };
        down.onclick = () => {
          down.classList.toggle('reacted', true);
          up.classList.toggle('reacted', false);
        };

        reactions.appendChild(label);
        reactions.appendChild(up);
        reactions.appendChild(down);
        bubble.appendChild(reactions);
      }

      if (who === 'bot') {
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
        row.appendChild(avatar);
      }

      row.classList.add('fade-in');
      log.appendChild(row);
      hideHero();
      try {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      } catch (e) {
        window.scrollTo(0, document.body.scrollHeight);
      }
    }

    function initials(name) {
      if (!name) return 'U';
      const parts = name.trim().split(/\s+/);
      const a = parts[0]?.[0] || '';
      const b = parts[1]?.[0] || '';
      return (a + b).toUpperCase() || 'U';
    }

    function renderProfile() {
      // Static branding
      const profName = document.getElementById('profName');
      const profEmail = document.getElementById('profEmail');
      if (profName) profName.textContent = 'Draco AI';
      if (profEmail) profEmail.textContent = 'Powered by Aryan and his co-workers';
      // Render memory card with stored info
      const memInfo = document.getElementById('memInfo');
      if (!memInfo) return;
      const p = (user && user.profile) ? user.profile : {};
      const name = p.name || 'â€”';
      const hobbies = Array.isArray(p.hobbies) ? p.hobbies.join(', ') : (p.hobbies || 'â€”');
      const fav = p.favorite_subject || 'â€”';
      memInfo.innerHTML = `
        <div><strong>Name:</strong> ${name}</div>
        <div><strong>Hobbies:</strong> ${hobbies}</div>
        <div><strong>Favorite Subject:</strong> ${fav}</div>
      `;
    }

    function refreshAuthUI() {
      if (!authStatus || !loginEmail || !loginBtn || !logoutBtn) return;
      if (user && user.logged_in) {
        const verified = user.profile && user.profile.verified;
        authStatus.textContent = (verified ? 'Verified: ' : 'Signed in: ') + (user.email || '');
        loginEmail.value = user.email || '';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
      } else {
        authStatus.textContent = 'Guest â€“ chats not saved';
        loginEmail.value = '';
        if (loginCode) loginCode.value = '';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
      }
    }

    function renderHistory() {
      const container = document.getElementById('history');
      if (!container) return;
      container.innerHTML = '';
      // Render chat list with names first
      const list = document.createElement('div');
      (chatsList || []).forEach((c) => {
        const d = document.createElement('div');
        d.className = 'hitem';
        d.textContent = c.name || 'New Chat';
        d.onclick = async () => {
          try {
            await fetch('/api/chats/select', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: c.id }) });
            await loadHistory();
          } catch (e) {}
        };
        list.appendChild(d);
      });
      container.appendChild(list);
      // recent messages preview under list
      historyItems.slice(-30).forEach((it) => {
        const text = (it.who === 'user' ? 'You: ' : 'Draco: ') + it.text;
        const d = document.createElement('div');
        d.className = 'hitem';
        d.textContent = text.length > 80 ? text.slice(0, 77) + 'â€¦' : text;
        try { d.title = new Date((it.ts||0)*1000).toLocaleString(); } catch (e) {}
        d.onclick = () => {
          appendItem(it.text, it.who === 'user' ? 'user' : 'bot');
        };
        container.appendChild(d);
      });
    }

    let voiceEnabled = false;
    function speakText(text) {
      try {
        if (!voiceEnabled) return; // gated by user gesture
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1.0;
        utter.pitch = 1.0;
        utter.lang = 'en-US';
        window.speechSynthesis.speak(utter);
      } catch (e) { /* no-op */ }
    }

    stopSpeakBtn.onclick = () => window.speechSynthesis.cancel();

    function maybeAddFollowup(botText) {
      try {
        const plain = String(botText || '');
        if (plain.length < 220) return;
        if (Math.random() > 0.25) return; // 25% chance
        const followups = [
          "Want me to break that down into simpler steps?",
          "If you like, I can turn this into a quick to-do list.",
          "Need an example or a shorter version of that?",
          "We can make a mini-plan out of this. Want to?",
          "If you're stuck, I can re-explain it in a different way."
        ];
        const line = followups[Math.floor(Math.random() * followups.length)];
        appendItem(line, 'bot');
      } catch (e) {}
    }

    async function sendCommand(text) {
      if (!text) return;
      appendItem(text, 'user');
      hideError();
      setBusy(true);
      showTyping(true);
      // Prefer socket if connected
      if (socket && socket.connected) {
        try {
          socket.emit('user_command', { text });
          return;
        } catch (e) {
          setBusy(false);
          showTyping(false);
        }
      }
      // Fallback to HTTP
      try {
        const r = await fetch('/api/command', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        setBusy(false);
        showTyping(false);
        if (data && data.action === 'open_url' && data.url) {
          try { window.open(data.url, '_blank'); } catch (e) {}
        }
        const t = (data && data.text) ? String(data.text) : (data && data.error) ? String(data.error) : 'No response';
        if (t) {
          appendItem(t, 'bot');
          speakText(t);
          maybeAddFollowup(t);
        }
        if (data && Array.isArray(data.sources_labeled) && data.sources_labeled.length) {
          const list = data.sources_labeled.map(s => `<a href="${s.url}" target="_blank" rel="noopener noreferrer">${s.label}</a>`).join(' | ');
          appendItem('Sources: ' + list, 'bot');
        }
      } catch (e) {
        setBusy(false);
        showTyping(false);
        showError('Request failed. Please retry.', ()=> sendCommand(text));
      }
    }

    async function loadMe() {
      try {
        const r = await fetch('/me');
        const d = await r.json();
        user = d || { logged_in:false };
        if (!user.logged_in) {
          appendItem('Guest mode: your chats won\'t be saved. Profile stored locally.', 'bot');
          // load guest profile into memory card
          try {
            const gp = await fetch('/api/guest_profile');
            const gd = await gp.json();
            if (gd && gd.ok) { user.profile = gd.profile || {}; renderProfile(); }
          } catch (e) {}
          refreshAuthUI();
          return;
        }
        if (heroGreeting) {
          const name = (user.profile && user.profile.name) || user.email || 'friend';
          heroGreeting.textContent = 'Good to see you, ' + name + '.';
        }
        appendItem('Signed in as ' + user.email, 'bot');
        renderProfile();
        await loadHistory();
        await maybeRunOnboarding();
        refreshAuthUI();
      } catch (e) { /* ignore */ }
    }

    async function loadHistory() {
      try {
        const [h, l] = await Promise.all([
          fetch('/api/chat_history'),
          fetch('/api/chats')
        ]);

        // Handle not_verified / auth errors gracefully
        if (!h.ok) {
          try {
            const err = await h.json();
            if (err && err.error === 'not_verified') {
              appendItem('Verify your email to use saved chats. Your current session is guest-only.', 'bot');
              return;
            }
          } catch (e) {}
          return;
        }

        const d = await h.json();
        if (!d.ok) {
          if (d.error === 'not_verified') {
            appendItem('Verify your email to use saved chats.', 'bot');
          }
          return;
        }
        historyItems = d.items || [];
        if (l.ok) {
          try {
            const dl = await l.json();
            if (dl && dl.ok) {
              chatsList = dl.chats || [];
            } else if (dl && dl.error === 'not_verified') {
              appendItem('Verify your email to see your saved chat list.', 'bot');
            }
          } catch (e) {}
        }
        log.innerHTML = '';
        if (historyItems.length) {
          if (chatHero) chatHero.style.display = 'none';
          historyItems.slice(-20).forEach(it => {
            appendItem(it.text, it.who === 'user' ? 'user' : 'bot');
          });
        } else {
          if (chatHero) chatHero.style.display = '';
        }
        renderHistory();
      } catch (e) {}
    }

    async function maybeRunOnboarding() {
      if (!user.logged_in) return;
      try {
        const r = await fetch('/api/profile');
        if (!r.ok) return;
        const d = await r.json();
        if (!d.ok) return;
        const p = d.profile || {};
        const needed = [];
        if (!p.name) needed.push('name');
        if (!p.language) needed.push('language');
        if (!p.interests) needed.push('interests');
        if (needed.length === 0) return;
        appendItem('Let\'s personalize your experience. I\'ll ask a few quick questions.', 'bot');
        const updates = {};
        if (needed.includes('name')) {
          const v = prompt('What should I call you?');
          if (v) updates.name = v.trim();
        }
        if (needed.includes('language')) {
          const v = prompt('Preferred language (e.g., English, Hindi)?');
          if (v) updates.language = v.trim();
        }
        if (needed.includes('interests')) {
          const v = prompt('Your interests (comma-separated)?');
          if (v) updates.interests = v.trim();
        }
        if (Object.keys(updates).length) {
          await fetch('/api/profile', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(updates) });
          appendItem('Thanks! I\'ll use that to tailor my replies.', 'bot');
        }
      } catch (e) {}
    }

    sendBtn.onclick = () => {
      const val = (input.value || '').trim();
      if (!val) return;
      sendCommand(val);
      input.value = '';
      input.focus();
    };

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    if (socket) {
      socket.on('connect', () => {
        appendItem('Connected to Draco!', 'bot');
        dot.classList.add('on');
        statusText.textContent = 'Online';
        sendBtn.disabled = false;
        micBtn.disabled = false;
        // Load user state/history after connection
        loadMe();
      });
      socket.on('disconnect', () => {
        appendItem('Disconnected. Using HTTP fallbackâ€¦', 'bot');
        dot.classList.remove('on');
        statusText.textContent = 'HTTP mode';
      });
      socket.on('draco_response', (data) => {
        if (!data) return;
        if (data.action === 'open_url' && data.url) {
          try { window.open(data.url, '_blank'); } catch (e) {}
        }
        const text = (data && data.text) ? String(data.text) : '';
        if (text) {
          appendItem(text, 'bot');
          speakText(text);
          maybeAddFollowup(text);
        }
        if (data && Array.isArray(data.sources_labeled) && data.sources_labeled.length) {
          const list = data.sources_labeled.map(s => `<a href="${s.url}" target="_blank" rel="noopener noreferrer">${s.label}</a>`).join(' | ');
          appendItem('Sources: ' + list, 'bot');
        }
        showTyping(false);
      });
    } else {
      statusText.textContent = 'HTTP mode';
    }

    // Enable speech on first interaction (autoplay policies)
    document.addEventListener('click', () => {
      if (!voiceEnabled) {
        try { window.speechSynthesis.resume(); } catch (e) {}
        voiceEnabled = true;
      }
    }, { once: true });

    // Browser voice input (Web Speech API) â€“ best effort
    let recognition = null;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-IN';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        sendBtn.click();
      };
      recognition.onerror = (e) => appendItem('Mic error: ' + e.error, 'bot');
      recognition.onend = () => micBtn.disabled = false;
    }

    micBtn.onclick = () => {
      if (!recognition) {
        appendItem('Speech recognition not supported in this browser.', 'bot');
        return;
      }
      try {
        micBtn.disabled = true;
        recognition.start();
      } catch (e) {
        micBtn.disabled = false;
      }
    };

    // Quick chips
    document.getElementById('chips').addEventListener('click', (e) => {
      const t = e.target.closest('.chip');
      if (!t) return;
      const cmd = t.getAttribute('data-cmd');
      input.value = cmd;
      sendBtn.click();
    });
    // Sidebar controls
    const layoutEl = document.getElementById('layout');
    const toggleSide = document.getElementById('toggleSide');
    const expandSide = document.getElementById('expandSide');
    let collapsed = false; let expanded = false;
    toggleSide.onclick = () => {
      collapsed = !collapsed;
      layoutEl.classList.toggle('collapsed', collapsed);
      toggleSide.textContent = collapsed ? 'Show Sidebar' : 'Hide Sidebar';
    };
    expandSide.onclick = () => {
      expanded = !expanded;
      layoutEl.classList.toggle('expanded', expanded);
      expandSide.textContent = expanded ? 'Shrink' : 'Expand';
    };
    // Removed New Chat / Clear buttons per request
    // Update sidebar in guest mode too
    renderProfile();

    const quickActionsBtn = document.getElementById('quickActionsBtn');
    const qaModal = document.getElementById('quickActionsModal');
    const qaBackdrop = document.querySelector('#quickActionsModal .qa-backdrop');
    const qaCloseBtn = document.getElementById('qaCloseBtn');
    function openQAModal(){
      if (!qaModal) return;
      qaModal.classList.add('open');
      const topic = document.getElementById('genTopicSide');
      if (topic) {
        setTimeout(()=> topic.focus(), 50);
      }
    }
    function closeQAModal(){
      if (!qaModal) return;
      qaModal.classList.remove('open');
    }
    if (quickActionsBtn) {
      quickActionsBtn.onclick = () => {
        try { openQAModal(); } catch (e) {}
      };
    }
    if (qaBackdrop) {
      qaBackdrop.onclick = () => { closeQAModal(); };
    }
    if (qaCloseBtn) {
      qaCloseBtn.onclick = () => { closeQAModal(); };
    }

    if (loginBtn) {
      let codeSentFor = null;
      loginBtn.onclick = async () => {
        const email = (loginEmail && loginEmail.value || '').trim().toLowerCase();
        if (!email || email.indexOf('@') === -1) {
          appendItem('Enter a valid email to continue.', 'bot');
          return;
        }
        // Step 1: send code
        if (!codeSentFor || codeSentFor !== email) {
          try {
            const r = await fetch('/login/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email })
            });
            const d = await r.json();
            if (!r.ok || !d.ok) {
              appendItem('Could not send code: ' + (d.error || 'error'), 'bot');
              return;
            }
            codeSentFor = email;
            loginBtn.textContent = 'Verify Code';
            appendItem('I have generated a verification code for ' + email + '. Enter it and press Verify.', 'bot');
          } catch (e) {
            appendItem('Error sending verification code. Please try again.', 'bot');
          }
          return;
        }

        // Step 2: verify code
        const code = (loginCode && loginCode.value || '').trim();
        if (!code) {
          appendItem('Enter the verification code you received.', 'bot');
          return;
        }
        try {
          const r = await fetch('/login/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, code })
          });
          const d = await r.json();
          if (!r.ok || !d.ok) {
            const err = d.error || 'verification_failed';
            if (err === 'code_expired') {
              appendItem('Code expired. Press Send Code again for a new one.', 'bot');
              codeSentFor = null;
              loginBtn.textContent = 'Send Code';
            } else if (err === 'invalid_code') {
              appendItem('That code did not match. Check it and try again.', 'bot');
            } else {
              appendItem('Verification failed: ' + err, 'bot');
            }
            return;
          }
          user = { logged_in: true, email: d.email || email, profile: d.profile || {} };
          appendItem('Verified and signed in as ' + user.email + '. Your chats will be saved.', 'bot');
          codeSentFor = null;
          loginBtn.textContent = 'Send Code';
          if (loginCode) loginCode.value = '';
          await loadHistory();
          refreshAuthUI();
        } catch (e) {
          appendItem('Verification error. Please try again.', 'bot');
        }
      };
    }

    if (logoutBtn) {
      logoutBtn.onclick = async () => {
        try {
          await fetch('/logout', { method: 'POST' });
        } catch (e) {}
        user = { logged_in: false, email: null, profile: {} };
        historyItems = [];
        chatsList = [];
        log.innerHTML = '';
        renderHistory();
        refreshAuthUI();
        appendItem('Switched to guest mode. Chats will not be saved.', 'bot');
      };
    }

    const newChatBtn = document.getElementById('newChatBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');

    if (newChatBtn) {
      newChatBtn.onclick = async () => {
        if (!user || !user.logged_in) {
          appendItem('Sign in with an email to create saved chats.', 'bot');
          return;
        }
        try {
          const r = await fetch('/api/chats/new', { method: 'POST' });
          const d = await r.json();
          if (!r.ok || !d.ok) {
            appendItem('Could not start new chat.', 'bot');
            return;
          }
          log.innerHTML = '';
          historyItems = [];
          await loadHistory();
        } catch (e) {
          appendItem('Error creating new chat.', 'bot');
        }
      };
    }

    if (clearChatBtn) {
      clearChatBtn.onclick = async () => {
        if (!user || !user.logged_in) {
          log.innerHTML = '';
          historyItems = [];
          renderHistory();
          appendItem('Cleared current guest view.', 'bot');
          return;
        }
        try {
          const r = await fetch('/api/chats/clear', { method: 'POST' });
          const d = await r.json();
          if (!r.ok || !d.ok) {
            appendItem('Could not clear chat.', 'bot');
            return;
          }
          log.innerHTML = '';
          historyItems = [];
          await loadHistory();
        } catch (e) {
          appendItem('Error clearing chat.', 'bot');
        }
      };
    }

    // Theme checkbox toggle wiring with persistence
    const THEME_KEY = 'draco-theme';
    const themeCheckbox = document.getElementById('themeCheckbox');
    function applyTheme(theme){
      document.body.classList.remove('light-mode','dark-mode');
      document.body.classList.add(theme);
      try { localStorage.setItem(THEME_KEY, theme); } catch (e) {}
      if (themeCheckbox) themeCheckbox.checked = (theme === 'light-mode');
    }
    const savedTheme = (function(){ try { return localStorage.getItem(THEME_KEY); } catch (e) { return null; } })();
    applyTheme(savedTheme || 'light-mode');
    if (themeCheckbox) {
      themeCheckbox.addEventListener('change', () => {
        const next = themeCheckbox.checked ? 'light-mode' : 'dark-mode';
        applyTheme(next);
      });
    }

    // Upload & Process
    const fileInput = document.getElementById('fileInput');
    const instructionEl = document.getElementById('instruction');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadNote = document.getElementById('uploadNote');
    const chooseFileBtn = document.getElementById('chooseFileBtn');
    const fileNameLabel = document.getElementById('fileNameLabel');
    const dropZone = document.getElementById('dropZone');
    const uploadProgress = document.getElementById('uploadProgress');
    const downloadsPanel = document.getElementById('downloadsPanel');
    const uploadStep = document.getElementById('uploadStep');
    let droppedFile = null;
    if (chooseFileBtn) {
      chooseFileBtn.onclick = () => { fileInput.click(); };
    }
    if (fileInput) {
      fileInput.onchange = () => {
        try {
          const f = fileInput.files && fileInput.files[0];
          fileNameLabel.textContent = f ? ('Selected: ' + f.name) : '';
          droppedFile = null;
          if (f) fileSizeLabel.textContent = (Math.round(f.size/1024)/1024).toFixed(2) + ' MB'; else fileSizeLabel.textContent='';
        } catch (e) {}
      };
    }
    if (dropZone) {
      ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); dropZone.classList.add('dragover'); }));
      ;['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); dropZone.classList.remove('dragover'); }));
      dropZone.addEventListener('drop', (e) => {
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) {
          droppedFile = f;
          fileNameLabel.textContent = 'Selected (dropped): ' + f.name;
          fileSizeLabel.textContent = (Math.round(f.size/1024)/1024).toFixed(2) + ' MB';
        }
      });
    }
    uploadBtn.onclick = async () => {
      uploadNote.textContent = 'Processing...';
      hideError(); setBusy(true);
      if (uploadStep) uploadStep.textContent = 'Uploadingâ€¦';
      const f = (fileInput.files && fileInput.files[0]) || droppedFile;
      if (!f) { uploadNote.textContent = 'Please choose a file.'; return; }
      const fd = new FormData();
      fd.append('file', f);
      fd.append('instruction', (instructionEl.value||'').trim());
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload_process');
        if (uploadProgress) uploadProgress.style.display = 'block';
        const bar = uploadProgress ? uploadProgress.querySelector('span') : null;
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable && bar) {
            const pct = Math.min(100, Math.round((e.loaded / e.total) * 100));
            bar.style.width = pct + '%';
          }
        };
        xhr.onload = () => {
          if (uploadProgress) { uploadProgress.style.display = 'none'; if (bar) bar.style.width = '0%'; }
          try {
            if (uploadStep) uploadStep.textContent = 'Processingâ€¦';
            const j = JSON.parse(xhr.responseText || '{}');
            if (!j.ok) { uploadNote.textContent = 'Error: ' + (j.error||'failed'); return; }
            let msg = '';
            if (j.summary) msg += 'Summary:\n' + j.summary + '\n';
            if (j.text) msg += 'Text:\n' + j.text + '\n';
            appendItem(msg || 'Processed.', 'bot');
            if (j.doc) {
              const a = document.createElement('a');
              a.href = j.doc; a.target = '_blank'; a.textContent = 'Download processed file';
              uploadNote.innerHTML = ''; uploadNote.appendChild(a);
              if (downloadsPanel) {
                const li = document.createElement('div');
                const when = new Date().toLocaleString();
                li.innerHTML = `<a href="${j.doc}" target="_blank">${when} - ${f.name}</a>`;
                downloadsPanel.prepend(li);
              }
            } else {
              uploadNote.textContent = 'Done.';
            }
            if (uploadStep) uploadStep.textContent = '';
            setBusy(false);
          } catch (e) {
            setBusy(false);
            if (uploadStep) uploadStep.textContent = '';
            showError('Upload failed.', ()=> uploadBtn.click());
            uploadNote.textContent = 'Upload failed.';
          }
        };
        xhr.onerror = () => {
          if (uploadProgress) uploadProgress.style.display = 'none';
          if (uploadStep) uploadStep.textContent = '';
          setBusy(false);
          showError('Upload failed.', ()=> uploadBtn.click());
          uploadNote.textContent = 'Upload failed.';
        };
        xhr.send(fd);
      } catch (e) {
        if (uploadProgress) uploadProgress.style.display = 'none';
        if (uploadStep) uploadStep.textContent = '';
        setBusy(false);
        showError('Upload failed.', ()=> uploadBtn.click());
        uploadNote.textContent = 'Upload failed.';
      }
    };

    // Ambient flame particles for buttons
    function spawnFlames(container){
      for(let i=0;i<6;i++){
        const p = document.createElement('div');
        p.className = 'flame-particle';
        p.style.left = (20 + Math.random()*60) + '%';
        p.style.bottom = (Math.random()*6) + 'px';
        p.style.animationDelay = (Math.random()*1.5) + 's';
        p.style.opacity = 0.6 + Math.random()*0.4;
        container.style.overflow = 'visible';
        container.appendChild(p);
      }
    }
    document.querySelectorAll('.button-container').forEach(spawnFlames);

    // Generate Files (Sidebar only)
    const genTopicSide = document.getElementById('genTopicSide');
    document.getElementById('genPPTSide').onclick = () => {
      const t = (genTopicSide.value||'').trim(); if (!t) return;
      sendCommand('generate ppt on ' + t);
    };
    document.getElementById('genDOCSide').onclick = () => {
      const t = (genTopicSide.value||'').trim(); if (!t) return;
      sendCommand('generate doc on ' + t);
    };

    // Memory card actions
    const editInfoBtn = document.getElementById('editInfoBtn');
    const forgetMeBtn = document.getElementById('forgetMeBtn');
    if (editInfoBtn) {
      editInfoBtn.onclick = async () => {
        try {
          const cur = (user && user.profile) ? user.profile : {};
          const name = prompt('Your name?', cur.name || '');
          const hobbies = prompt('Your hobbies (comma-separated)?', Array.isArray(cur.hobbies) ? cur.hobbies.join(', ') : (cur.hobbies || ''));
          const fav = prompt('Favorite subject?', cur.favorite_subject || '');
          const body = {};
          if (name !== null) body.name = name.trim();
          if (hobbies !== null) body.hobbies = hobbies.split(',').map(s => s.trim()).filter(Boolean);
          if (fav !== null) body.favorite_subject = fav.trim();
          const url = (user && user.logged_in) ? '/api/profile' : '/api/guest_profile';
          const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          const d = await r.json();
          if (d && d.ok) { user.profile = d.profile || {}; renderProfile(); appendItem('Profile updated.', 'bot'); }
          else appendItem('Failed to update profile.', 'bot');
        } catch (e) { appendItem('Error updating profile.', 'bot'); }
      };
    }
    if (forgetMeBtn) {
      forgetMeBtn.onclick = async () => {
        try {
          const yes = confirm('This will clear your stored profile. Continue?');
          if (!yes) return;
          const url = (user && user.logged_in) ? '/api/profile/clear' : '/api/guest_profile/clear';
          const r = await fetch(url, { method:'POST' });
          const d = await r.json();
          if (d && d.ok) { user.profile = {}; renderProfile(); appendItem('Your profile has been cleared.', 'bot'); }
          else appendItem('Failed to clear profile.', 'bot');
        } catch (e) { appendItem('Error clearing profile.', 'bot'); }
      };
    }
    document.getElementById('genPDFSide').onclick = () => {
      const t = (genTopicSide.value||'').trim(); if (!t) return;
      sendCommand('generate pdf on ' + t);
    };

    // File instruction chips under main box (not in sidebar)
    const fileChips = document.getElementById('fileChips');
    if (fileChips) {
      fileChips.addEventListener('click', async (e) => {
        const t = e.target.closest('.chip');
        if (!t) return;
        const instr = t.getAttribute('data-instruction') || '';
        if (instructionEl) instructionEl.value = instr;
        const f = fileInput.files && fileInput.files[0];
        if (!f) {
          uploadNote.textContent = 'Please choose a file first.';
          try { chooseFileBtn.focus(); } catch (e) {}
          return;
        }
        uploadBtn.click();
      });
    }

    // Summary length presets (no external API needed)
    const summaryChips = document.getElementById('summaryChips');
    if (summaryChips) {
      summaryChips.addEventListener('click', (e) => {
        const t = e.target.closest('.chip');
        if (!t) return;
        const kind = t.getAttribute('data-summary');
        if (instructionEl) instructionEl.value = `summarize:${kind}`;
        const f = (fileInput.files && fileInput.files[0]) || droppedFile;
        if (!f) { uploadNote.textContent = 'Please choose a file first.'; return; }
        uploadBtn.click();
      });
    }

    // Daily motivation (once per day)
    (function(){
      const KEY = 'draco-motivation-date';
      try {
        const today = new Date().toISOString().slice(0,10);
        const last = localStorage.getItem(KEY);
        if (last !== today) {
          const lines = [
            'New day, new XP. Even 30 focused minutes today will move you forward.',
            'Tiny consistent steps beat random big bursts. What shall we tackle first?',
            'You showed up. That already puts you ahead of who you were yesterday.',
            'Letâ€™s make at least one thing today that Future You will be proud of.',
            'No pressure for perfectionâ€”just progress. Iâ€™m here with you.'
          ];
          const msg = lines[Math.floor(Math.random()*lines.length)];
          appendItem(msg, 'bot');
          localStorage.setItem(KEY, today);
        }
      } catch (e) {}
    })();

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key.toLowerCase() === 'k') { e.preventDefault(); try { document.getElementById('input').focus(); } catch(_){} }
      if (e.altKey && (e.key.toLowerCase() === 'u')) { e.preventDefault(); chooseFileBtn && chooseFileBtn.click(); }
      if (e.altKey && (e.key.toLowerCase() === 's')) { e.preventDefault(); if (instructionEl) instructionEl.value = 'summarize:short'; uploadBtn && uploadBtn.click(); }
      if (e.altKey && (e.key.toLowerCase() === 'p')) { e.preventDefault(); const t = (document.getElementById('genTopicSide').value||'').trim(); if (t) sendCommand('generate pdf on ' + t); }
      if (e.altKey && (e.key.toLowerCase() === 'd')) { e.preventDefault(); const t = (document.getElementById('genTopicSide').value||'').trim(); if (t) sendCommand('generate doc on ' + t); }
      if (e.altKey && (e.key.toLowerCase() === 'f')) { e.preventDefault(); if (instructionEl) instructionEl.value = 'flashcards'; uploadBtn && uploadBtn.click(); }
    });
  </script>
</body>
</html>


