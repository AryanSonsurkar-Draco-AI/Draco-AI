<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draco Assistant</title>
  <style>
    :root {
      --bg-start: #060812;
      --bg-end: #0b1020;
      --card: #0f1230;
      --accent: #6f8dff;
      --accent-2: #12ffe6;
      --text: #eaf1ff;
      --muted: #9aa3c1;
      --glow: 0 0 12px rgba(111,141,255,.7), 0 0 28px rgba(18,255,230,.35);
      --glow-strong: 0 0 18px rgba(111,141,255,.85), 0 0 42px rgba(18,255,230,.6);
    }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, Arial, sans-serif; margin: 0; color: var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(44,56,168,.25), transparent 60%),
                  radial-gradient(1000px 800px at 90% 10%, rgba(18,255,230,.09), transparent 55%),
                  linear-gradient(180deg, var(--bg-start), var(--bg-end));
      min-height: 100dvh;
    }
    .wrap { max-width: 880px; margin: 48px auto; padding: 0 18px; }
    h1 { font-size: 30px; margin: 0 0 10px; letter-spacing: 0.4px; }
    .status { display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 14px; margin-bottom: 14px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#ff5c5c; box-shadow: 0 0 8px rgba(255,92,92,.6); }
    .dot.on { background:#25ff9b; box-shadow: 0 0 10px rgba(37,255,155,.8); }
    .card { position:relative; background: linear-gradient(180deg, #0e1232, #0b0f29); border: 1px solid rgba(111,141,255,.22); border-radius: 14px; padding: 16px; box-shadow: var(--glow); }
    .row { display: flex; gap: 10px; }
    .input { display:flex; gap:10px; align-items:center; padding:10px; border-radius: 12px; border:1px solid rgba(111,141,255,.18); background:#0a0e26; box-shadow: inset 0 0 0 1px rgba(18,255,230,.08); }
    input[type=text] { flex: 1; padding: 12px; border-radius: 10px; border: none; outline: none; background: transparent; color: var(--text); font-size: 15px; }
    .btn { padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(111,141,255,.35); background: linear-gradient(180deg, #1b2370, #16205a); color: var(--text); cursor: pointer; box-shadow: var(--glow); transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease; }
    .btn:hover { box-shadow: var(--glow-strong); border-color: rgba(18,255,230,.65); transform: translateY(-1px); }
    .btn:disabled { opacity:.55; cursor:not-allowed; filter: grayscale(.3); }
    .chipbar { display:flex; flex-wrap: wrap; gap:8px; margin-top:10px; }
    .chip { padding:8px 12px; border-radius: 999px; border:1px solid rgba(111,141,255,.28); color:#cfe3ff; background: linear-gradient(180deg, #10173d, #0c1434); cursor:pointer; box-shadow: 0 0 0 1px rgba(18,255,230,.05) inset; }
    .chip:hover { box-shadow: var(--glow); }
    .log { margin-top: 16px; max-height: 440px; overflow: auto; padding-right: 4px; }
    .item { background:#0a0f2a; border:1px solid rgba(111,141,255,.18); border-radius: 12px; padding:12px; margin:10px 0; box-shadow: 0 0 0 1px rgba(18,255,230,.05) inset; }
    .user { color:#9ec0ff; text-shadow: 0 0 8px rgba(111,141,255,.4); }
    .bot { color:#8bffe7; text-shadow: 0 0 10px rgba(18,255,230,.5); }
    small { color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Draco Assistant</h1>
    <div class="status"><span class="dot" id="dot"></span><span id="statusText">Connectingâ€¦</span></div>
    <div class="card">
      <div class="input" style="margin-bottom:10px;">
        <input id="input" type="text" placeholder="Type a command (e.g., open youtube, play music, take note ...)" />
        <button class="btn" id="sendBtn">Send</button>
      </div>
      <div class="row" style="margin-bottom:10px;">
        <button class="btn" id="micBtn">ðŸŽ¤ Speak</button>
        <button class="btn" id="stopSpeakBtn">ðŸ›‘ Stop Voice</button>
      </div>
      <div class="chipbar" id="chips">
        <div class="chip" data-cmd="open youtube">Open YouTube</div>
        <div class="chip" data-cmd="play music">Play Music</div>
        <div class="chip" data-cmd="take note buy milk">Take Note</div>
        <div class="chip" data-cmd="list notes">List Notes</div>
        <div class="chip" data-cmd="system status">System Status</div>
        <div class="chip" data-cmd="search for render deployment guide">Search Web</div>
      </div>
      <div class="log" id="log"></div>
      <small>Tip: Try "open youtube", "play music", "list notes", "remind me to drink water at 19:30"</small>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const log = document.getElementById('log');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const stopSpeakBtn = document.getElementById('stopSpeakBtn');
    const dot = document.getElementById('dot');
    const statusText = document.getElementById('statusText');

    let socket = null;
    try {
      socket = io({ transports: ['websocket', 'polling'], withCredentials: false });
    } catch (e) {
      socket = null;
    }

    function appendItem(text, who='bot') {
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<div class="${who}">${text}</div>`;
      log.appendChild(el);
      log.scrollTop = log.scrollHeight;
    }

    let voiceEnabled = false;
    function speakText(text) {
      try {
        if (!voiceEnabled) return; // gated by user gesture
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1.0;
        utter.pitch = 1.0;
        utter.lang = 'en-US';
        window.speechSynthesis.speak(utter);
      } catch (e) { /* no-op */ }
    }

    stopSpeakBtn.onclick = () => window.speechSynthesis.cancel();

    async function sendCommand(text) {
      if (!text) return;
      appendItem(text, 'user');
      // Prefer socket if connected
      if (socket && socket.connected) {
        try { socket.emit('user_command', { text }); return; } catch (e) {}
      }
      // Fallback to HTTP
      try {
        const r = await fetch('/api/command', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        const t = (data && data.text) ? String(data.text) : (data && data.error) ? String(data.error) : 'No response';
        appendItem(t, 'bot');
        speakText(t);
      } catch (e) {
        appendItem('Request failed. Please retry.', 'bot');
      }
    }

    sendBtn.onclick = () => {
      const val = (input.value || '').trim();
      if (!val) return;
      sendCommand(val);
      input.value = '';
      input.focus();
    };

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    if (socket) {
      socket.on('connect', () => {
        appendItem('Connected to Draco!', 'bot');
        dot.classList.add('on');
        statusText.textContent = 'Online';
        sendBtn.disabled = false;
        micBtn.disabled = false;
      });
      socket.on('disconnect', () => {
        appendItem('Disconnected. Using HTTP fallbackâ€¦', 'bot');
        dot.classList.remove('on');
        statusText.textContent = 'HTTP mode';
      });
      socket.on('draco_response', (data) => {
        const text = (data && data.text) ? String(data.text) : '';
        if (!text) return;
        appendItem(text, 'bot');
        speakText(text);
      });
    } else {
      statusText.textContent = 'HTTP mode';
    }

    // Enable speech on first interaction (autoplay policies)
    document.addEventListener('click', () => {
      if (!voiceEnabled) {
        try { window.speechSynthesis.resume(); } catch (e) {}
        voiceEnabled = true;
      }
    }, { once: true });

    // Browser voice input (Web Speech API) â€“ best effort
    let recognition = null;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-IN';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        sendBtn.click();
      };
      recognition.onerror = (e) => appendItem('Mic error: ' + e.error, 'bot');
      recognition.onend = () => micBtn.disabled = false;
    }

    micBtn.onclick = () => {
      if (!recognition) {
        appendItem('Speech recognition not supported in this browser.', 'bot');
        return;
      }
      try {
        micBtn.disabled = true;
        recognition.start();
      } catch (e) {
        micBtn.disabled = false;
      }
    };

    // Quick chips
    document.getElementById('chips').addEventListener('click', (e) => {
      const t = e.target.closest('.chip');
      if (!t) return;
      const cmd = t.getAttribute('data-cmd');
      input.value = cmd;
      sendBtn.click();
    });
  </script>
</body>
</html>


